import { defaultContainer } from '../core/defaultContainer';
import { ARRAY_PROPERTY, OBJECT_PROPERTY, PROPERTY } from "../const";
import { RegexValidator } from '../util/regex-validator';
import { SANITIZERS } from "../util/sanitizers";
import { instanceProvider, getInstance } from "../util/instance-provider.function";
export class BaseFormBuilder {
    constructor() {
    }
    createInstance() {
        let instance = {};
        defaultContainer.modelIncrementCount = defaultContainer.modelIncrementCount + 1;
        let modelName = `RxWebModel${defaultContainer.modelIncrementCount}`;
        instance.constructor = Function(`"use strict";return(function ${modelName}(){ })`)();
        return instance;
    }
    createClassObject(model, formBuilderConfiguration, classInstance) {
        let instanceContainer = defaultContainer.get(model);
        let autoInstanceConfig = formBuilderConfiguration ? formBuilderConfiguration.autoInstanceConfig : undefined;
        if (!autoInstanceConfig) {
            return classInstance && typeof classInstance != "function" ? classInstance : getInstance(model, []);
        }
        else {
            classInstance = classInstance && typeof classInstance != "function" ? classInstance : getInstance(model, autoInstanceConfig.arguments || []);
            if (autoInstanceConfig.objectPropInstanceConfig && autoInstanceConfig.objectPropInstanceConfig.length > 0) {
                autoInstanceConfig.objectPropInstanceConfig.forEach(t => {
                    let objectProperty = instanceContainer.properties.filter(property => property.name == t.propertyName && property.propertyType == OBJECT_PROPERTY)[0];
                    if (objectProperty) {
                        let data = classInstance[t.propertyName];
                        classInstance[t.propertyName] = getInstance(objectProperty.entity, t.arguments || []);
                        if (data)
                            this.setObjectValue(data, classInstance[t.propertyName]);
                    }
                });
            }
            if (autoInstanceConfig.arrayPropInstanceConfig && autoInstanceConfig.arrayPropInstanceConfig.length > 0) {
                autoInstanceConfig.arrayPropInstanceConfig.forEach(t => {
                    let property = instanceContainer.properties.filter(property => property.name == t.propertyName && property.propertyType == ARRAY_PROPERTY)[0];
                    if (property) {
                        let data = classInstance[t.propertyName];
                        classInstance[t.propertyName] = [];
                        for (var i = 0; i < t.rowItems; i++) {
                            let instance = getInstance(property.entity, t.arguments || []);
                            if (data && data[i])
                                this.setObjectValue(data[i], instance);
                            classInstance[t.propertyName].push(instance);
                        }
                    }
                });
            }
            return classInstance;
        }
    }
    updateObject(model, entityObject, formBuilderConfiguration) {
        let instanceContainer = instanceProvider(model);
        let classInstance = getInstance(model, []);
        if (instanceContainer) {
            instanceContainer.properties.forEach(t => {
                let entity = ((t.propertyType == OBJECT_PROPERTY || t.propertyType == ARRAY_PROPERTY) && t.entity) ? t.entity : (formBuilderConfiguration && formBuilderConfiguration.genericEntities) ? formBuilderConfiguration.genericEntities[t.name] : undefined;
                if (!entity && t.entityProvider)
                    entity = t.entityProvider.call(entityObject);
                switch (t.propertyType) {
                    case PROPERTY:
                        classInstance[t.name] = this.getValue(entityObject, t, formBuilderConfiguration);
                        break;
                    case OBJECT_PROPERTY:
                        let objectValue = this.getValue(entityObject, t, formBuilderConfiguration);
                        if (objectValue)
                            classInstance[t.name] = this.updateObject(entity, objectValue, formBuilderConfiguration);
                        break;
                    case ARRAY_PROPERTY:
                        let arrayObjectValue = this.getValue(entityObject, t, formBuilderConfiguration);
                        if (arrayObjectValue && Array.isArray(arrayObjectValue)) {
                            classInstance[t.name] = [];
                            for (let row of arrayObjectValue) {
                                let instanceObject = this.updateObject(entity, row, formBuilderConfiguration);
                                classInstance[t.name].push(instanceObject);
                            }
                        }
                        break;
                }
            });
        }
        return classInstance;
    }
    instaceProvider(instanceFunc, entityObject) {
        return instanceProvider(instanceFunc, entityObject);
    }
    getDefaultValue(propertyInfo, value, formBuilderConfiguration) {
        let defaultValue = (formBuilderConfiguration && formBuilderConfiguration.propsConfig && formBuilderConfiguration.propsConfig[propertyInfo.name] && formBuilderConfiguration.propsConfig[propertyInfo.name].defaultValue && !RegexValidator.isNotBlank(value)) ? formBuilderConfiguration.propsConfig[propertyInfo.name].defaultValue : (propertyInfo.defaultValue != undefined && !RegexValidator.isNotBlank(value)) ?
            propertyInfo.defaultValue :
            value;
        return defaultValue;
    }
    sanitizeValue(instanceContainer, propertyName, value, entityObject, baseObject) {
        if (instanceContainer.sanitizers && instanceContainer.sanitizers[propertyName]) {
            for (let sanitizer of instanceContainer.sanitizers[propertyName])
                value = SANITIZERS[sanitizer.name](value, sanitizer.config);
        }
        if (entityObject[propertyName] !== undefined && entityObject[propertyName] !== value)
            entityObject[propertyName] = value;
        if (baseObject[propertyName] !== undefined && baseObject[propertyName] !== value)
            baseObject[propertyName] = value;
        return value;
    }
    getValue(entityObject, propertyInfo, formBuilderConfiguration) {
        let propValue = (propertyInfo.dataPropertyName) ? entityObject[propertyInfo.dataPropertyName] : entityObject[propertyInfo.name];
        return this.getDefaultValue(propertyInfo, propValue, formBuilderConfiguration);
    }
    setObjectValue(entityObject, classInstance) {
        for (var column in entityObject) {
            classInstance[column] = entityObject[column];
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1mb3JtLWJ1aWxkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy9yZWFjdGl2ZS1mb3JtLXZhbGlkYXRvcnMvc2VydmljZXMvYmFzZS1mb3JtLWJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFNUQsT0FBTyxFQUFFLGNBQWMsRUFBRSxlQUFlLEVBQUUsUUFBUSxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ3BFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFDL0MsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFdBQVcsRUFBRSxNQUFNLG9DQUFvQyxDQUFBO0FBRWxGLE1BQU0sT0FBTyxlQUFlO0lBQ3hCO0lBQ0EsQ0FBQztJQUVTLGNBQWM7UUFDcEIsSUFBSSxRQUFRLEdBQUcsRUFBRSxDQUFDO1FBQ2xCLGdCQUFnQixDQUFDLG1CQUFtQixHQUFHLGdCQUFnQixDQUFDLG1CQUFtQixHQUFHLENBQUMsQ0FBQztRQUNoRixJQUFJLFNBQVMsR0FBRyxhQUFhLGdCQUFnQixDQUFDLG1CQUFtQixFQUFFLENBQUE7UUFDbkUsUUFBUSxDQUFDLFdBQVcsR0FBRyxRQUFRLENBQUMsZ0NBQWdDLFNBQVMsUUFBUSxDQUFDLEVBQUUsQ0FBQTtRQUNwRixPQUFPLFFBQVEsQ0FBQztJQUNwQixDQUFDO0lBRVMsaUJBQWlCLENBQUMsS0FBVSxFQUFFLHdCQUFrRCxFQUFFLGFBQW1CO1FBQzNHLElBQUksaUJBQWlCLEdBQUcsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3BELElBQUksa0JBQWtCLEdBQXVCLHdCQUF3QixDQUFDLENBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENB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QUMsQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNoSSxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxFQUFDLFNBQVMsRUFBQyx3QkFBd0IsQ0FBQyxDQUFDO0lBQ2pGLENBQUM7SUFFTyxjQUFjLENBQUMsWUFBb0MsRUFBRSxhQUFrQjtRQUMzRSxLQUFLLElBQUksTUFBTSxJQUFJLFlBQVksRUFBRTtZQUM3QixhQUFhLENBQUMsTUFBTSxDQUFDLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2hEO0lBQ0wsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uIH0gZnJvbSAnLi4vbW9kZWxzL2Zvcm0tYnVpbGRlci1jb25maWd1cmF0aW9uJ1xyXG5pbXBvcnQgeyBBdXRvSW5zdGFuY2VDb25maWcgfSBmcm9tICcuLi9tb2RlbHMvaW50ZXJmYWNlL2F1dG8taW5zdGFuY2UtY29uZmlnLmludGVyZmFjZSdcclxuaW1wb3J0IHsgZGVmYXVsdENvbnRhaW5lciB9IGZyb20gJy4uL2NvcmUvZGVmYXVsdENvbnRhaW5lcic7XHJcbmltcG9ydCB7IEluc3RhbmNlQ29udGFpbmVyLFByb3BlcnR5SW5mb30gZnJvbSAnLi4vY29yZS92YWxpZGF0b3IuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgQVJSQVlfUFJPUEVSVFksIE9CSkVDVF9QUk9QRVJUWSwgUFJPUEVSVFkgfSBmcm9tIFwiLi4vY29uc3RcIlxyXG5pbXBvcnQgeyBSZWdleFZhbGlkYXRvciB9IGZyb20gJy4uL3V0aWwvcmVnZXgtdmFsaWRhdG9yJztcclxuaW1wb3J0IHsgU0FOSVRJWkVSUyB9IGZyb20gXCIuLi91dGlsL3Nhbml0aXplcnNcIlxyXG5pbXBvcnQgeyBpbnN0YW5jZVByb3ZpZGVyLCBnZXRJbnN0YW5jZSB9IGZyb20gXCIuLi91dGlsL2luc3RhbmNlLXByb3ZpZGVyLmZ1bmN0aW9uXCJcclxuXHJcbmV4cG9ydCBjbGFzcyBCYXNlRm9ybUJ1aWxkZXIge1xyXG4gICAgY29uc3RydWN0b3IoKSB7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUluc3RhbmNlKCkge1xyXG4gICAgICAgIGxldCBpbnN0YW5jZSA9IHt9O1xyXG4gICAgICAgIGRlZmF1bHRDb250YWluZXIubW9kZWxJbmNyZW1lbnRDb3VudCA9IGRlZmF1bHRDb250YWluZXIubW9kZWxJbmNyZW1lbnRDb3VudCArIDE7XHJcbiAgICAgICAgbGV0IG1vZGVsTmFtZSA9IGBSeFdlYk1vZGVsJHtkZWZhdWx0Q29udGFpbmVyLm1vZGVsSW5jcmVtZW50Q291bnR9YFxyXG4gICAgICAgIGluc3RhbmNlLmNvbnN0cnVjdG9yID0gRnVuY3Rpb24oYFwidXNlIHN0cmljdFwiO3JldHVybihmdW5jdGlvbiAke21vZGVsTmFtZX0oKXsgfSlgKSgpXHJcbiAgICAgICAgcmV0dXJuIGluc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBjcmVhdGVDbGFzc09iamVjdChtb2RlbDogYW55LCBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb246IEZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbiwgY2xhc3NJbnN0YW5jZT86IGFueSkge1xyXG4gICAgICAgIGxldCBpbnN0YW5jZUNvbnRhaW5lciA9IGRlZmF1bHRDb250YWluZXIuZ2V0KG1vZGVsKTtcclxuICAgICAgICBsZXQgYXV0b0luc3RhbmNlQ29uZmlnOiBBdXRvSW5zdGFuY2VDb25maWcgPSBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24gPyBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24uYXV0b0luc3RhbmNlQ29uZmlnIDogdW5kZWZpbmVkO1xyXG4gICAgICAgIGlmICghYXV0b0luc3RhbmNlQ29uZmlnKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjbGFzc0luc3RhbmNlICYmIHR5cGVvZiBjbGFzc0luc3RhbmNlICE9IFwiZnVuY3Rpb25cIiA/IGNsYXNzSW5zdGFuY2UgOiBnZXRJbnN0YW5jZShtb2RlbCwgW10pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGNsYXNzSW5zdGFuY2UgPSBjbGFzc0luc3RhbmNlICYmIHR5cGVvZiBjbGFzc0luc3RhbmNlICE9IFwiZnVuY3Rpb25cIiA/IGNsYXNzSW5zdGFuY2UgOiBnZXRJbnN0YW5jZShtb2RlbCwgYXV0b0luc3RhbmNlQ29uZmlnLmFyZ3VtZW50cyB8fCBbXSlcclxuICAgICAgICAgICAgaWYgKGF1dG9JbnN0YW5jZUNvbmZpZy5vYmplY3RQcm9wSW5zdGFuY2VDb25maWcgJiYgYXV0b0luc3RhbmNlQ29uZmlnLm9iamVjdFByb3BJbnN0YW5jZUNvbmZpZy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICBhdXRvSW5zdGFuY2VDb25maWcub2JqZWN0UHJvcEluc3RhbmNlQ29uZmlnLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IG9iamVjdFByb3BlcnR5ID0gaW5zdGFuY2VDb250YWluZXIucHJvcGVydGllcy5maWx0ZXIocHJvcGVydHkgPT4gcHJvcGVydHkubmFtZSA9PSB0LnByb3BlcnR5TmFtZSAmJiBwcm9wZXJ0eS5wcm9wZXJ0eVR5cGUgPT0gT0JKRUNUX1BST1BFUlRZKVswXTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0UHJvcGVydHkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGRhdGEgPWNsYXNzSW5zdGFuY2VbdC5wcm9wZXJ0eU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc0luc3RhbmNlW3QucHJvcGVydHlOYW1lXSA9IGdldEluc3RhbmNlKG9iamVjdFByb3BlcnR5LmVudGl0eSwgdC5hcmd1bWVudHMgfHwgW10pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0T2JqZWN0VmFsdWUoZGF0YSwgY2xhc3NJbnN0YW5jZVt0LnByb3BlcnR5TmFtZV0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGF1dG9JbnN0YW5jZUNvbmZpZy5hcnJheVByb3BJbnN0YW5jZUNvbmZpZyAmJiBhdXRvSW5zdGFuY2VDb25maWcuYXJyYXlQcm9wSW5zdGFuY2VDb25maWcubGVuZ3RoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgYXV0b0luc3RhbmNlQ29uZmlnLmFycmF5UHJvcEluc3RhbmNlQ29uZmlnLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IHByb3BlcnR5ID0gaW5zdGFuY2VDb250YWluZXIucHJvcGVydGllcy5maWx0ZXIocHJvcGVydHkgPT4gcHJvcGVydHkubmFtZSA9PSB0LnByb3BlcnR5TmFtZSAmJiBwcm9wZXJ0eS5wcm9wZXJ0eVR5cGUgPT0gQVJSQVlfUFJPUEVSVFkpWzBdO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChwcm9wZXJ0eSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGF0YSA9IGNsYXNzSW5zdGFuY2VbdC5wcm9wZXJ0eU5hbWVdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc0luc3RhbmNlW3QucHJvcGVydHlOYW1lXSA9IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHQucm93SXRlbXM7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGluc3RhbmNlID0gZ2V0SW5zdGFuY2UocHJvcGVydHkuZW50aXR5LCB0LmFyZ3VtZW50cyB8fCBbXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YSAmJiBkYXRhW2ldKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0T2JqZWN0VmFsdWUoZGF0YVtpXSwgaW5zdGFuY2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NJbnN0YW5jZVt0LnByb3BlcnR5TmFtZV0ucHVzaChpbnN0YW5jZSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGNsYXNzSW5zdGFuY2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCB1cGRhdGVPYmplY3QobW9kZWw6IGFueSwgZW50aXR5T2JqZWN0OiBhbnksIGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbjogRm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uKSB7XHJcbiAgICAgICAgbGV0IGluc3RhbmNlQ29udGFpbmVyID0gaW5zdGFuY2VQcm92aWRlcihtb2RlbCk7XHJcbiAgICAgICAgbGV0IGNsYXNzSW5zdGFuY2UgPSBnZXRJbnN0YW5jZShtb2RlbCwgW10pO1xyXG4gICAgICAgIGlmIChpbnN0YW5jZUNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICBpbnN0YW5jZUNvbnRhaW5lci5wcm9wZXJ0aWVzLmZvckVhY2godCA9PiB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZW50aXR5ID0gKCh0LnByb3BlcnR5VHlwZSA9PSBPQkpFQ1RfUFJPUEVSVFkgfHwgdC5wcm9wZXJ0eVR5cGUgPT0gQVJSQVlfUFJPUEVSVFkpICYmIHQuZW50aXR5KSA/IHQuZW50aXR5IDogKGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbiAmJiBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24uZ2VuZXJpY0VudGl0aWVzKSA/IGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbi5nZW5lcmljRW50aXRpZXNbdC5uYW1lXSA6IHVuZGVmaW5lZDtcclxuICAgICAgICAgICAgICAgIGlmICghZW50aXR5ICYmIHQuZW50aXR5UHJvdmlkZXIpXHJcbiAgICAgICAgICAgICAgICAgICAgZW50aXR5ID0gdC5lbnRpdHlQcm92aWRlci5jYWxsKGVudGl0eU9iamVjdCk7XHJcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKHQucHJvcGVydHlUeXBlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBQUk9QRVJUWTpcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NJbnN0YW5jZVt0Lm5hbWVdID0gdGhpcy5nZXRWYWx1ZShlbnRpdHlPYmplY3QsIHQsIGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbilcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBPQkpFQ1RfUFJPUEVSVFk6XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvYmplY3RWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoZW50aXR5T2JqZWN0LCB0LCBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAob2JqZWN0VmFsdWUpIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NJbnN0YW5jZVt0Lm5hbWVdID0gdGhpcy51cGRhdGVPYmplY3QoZW50aXR5LCBvYmplY3RWYWx1ZSwgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgICAgICBjYXNlIEFSUkFZX1BST1BFUlRZOlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgYXJyYXlPYmplY3RWYWx1ZSA9IHRoaXMuZ2V0VmFsdWUoZW50aXR5T2JqZWN0LCB0LCBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24pO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXJyYXlPYmplY3RWYWx1ZSAmJiBBcnJheS5pc0FycmF5KGFycmF5T2JqZWN0VmFsdWUpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc0luc3RhbmNlW3QubmFtZV0gPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAobGV0IHJvdyBvZiBhcnJheU9iamVjdFZhbHVlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGluc3RhbmNlT2JqZWN0ID0gdGhpcy51cGRhdGVPYmplY3QoZW50aXR5LCByb3csIGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc0luc3RhbmNlW3QubmFtZV0ucHVzaChpbnN0YW5jZU9iamVjdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBjbGFzc0luc3RhbmNlO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBwcm90ZWN0ZWQgaW5zdGFjZVByb3ZpZGVyKGluc3RhbmNlRnVuYzogYW55LCBlbnRpdHlPYmplY3Q6IGFueSk6IEluc3RhbmNlQ29udGFpbmVyIHtcclxuICAgICAgICByZXR1cm4gaW5zdGFuY2VQcm92aWRlcihpbnN0YW5jZUZ1bmMsIGVudGl0eU9iamVjdCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldERlZmF1bHRWYWx1ZShwcm9wZXJ0eUluZm86IFByb3BlcnR5SW5mbywgdmFsdWU6IGFueSwgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uOiBGb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24pIHtcclxuICAgICAgICBsZXQgZGVmYXVsdFZhbHVlID0gKGZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbiAmJiBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24ucHJvcHNDb25maWcgJiYgZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uLnByb3BzQ29uZmlnW3Byb3BlcnR5SW5mby5uYW1lXSAmJiBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb24ucHJvcHNDb25maWdbcHJvcGVydHlJbmZvLm5hbWVdLmRlZmF1bHRWYWx1ZSAmJiAhUmVnZXhWYWxpZGF0b3IuaXNOb3RCbGFuayh2YWx1ZSkpID8gZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uLnByb3BzQ29uZmlnW3Byb3BlcnR5SW5mby5uYW1lXS5kZWZhdWx0VmFsdWUgOiAocHJvcGVydHlJbmZvLmRlZmF1bHRWYWx1ZSAhPSB1bmRlZmluZWQgJiYgIVJlZ2V4VmFsaWRhdG9yLmlzTm90QmxhbmsodmFsdWUpKSA/XHJcbiAgICAgICAgICAgIHByb3BlcnR5SW5mby5kZWZhdWx0VmFsdWUgOlxyXG4gICAgICAgICAgICB2YWx1ZVxyXG4gICAgICAgIHJldHVybiBkZWZhdWx0VmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHNhbml0aXplVmFsdWUoaW5zdGFuY2VDb250YWluZXI6IEluc3RhbmNlQ29udGFpbmVyLCBwcm9wZXJ0eU5hbWU6IHN0cmluZywgdmFsdWU6IGFueSwgZW50aXR5T2JqZWN0OiBhbnksIGJhc2VPYmplY3Q6IGFueSkge1xyXG4gICAgICAgIGlmIChpbnN0YW5jZUNvbnRhaW5lci5zYW5pdGl6ZXJzICYmIGluc3RhbmNlQ29udGFpbmVyLnNhbml0aXplcnNbcHJvcGVydHlOYW1lXSkge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBzYW5pdGl6ZXIgb2YgaW5zdGFuY2VDb250YWluZXIuc2FuaXRpemVyc1twcm9wZXJ0eU5hbWVdKVxyXG4gICAgICAgICAgICAgICAgdmFsdWUgPSBTQU5JVElaRVJTW3Nhbml0aXplci5uYW1lXSh2YWx1ZSxzYW5pdGl6ZXIuY29uZmlnKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGVudGl0eU9iamVjdFtwcm9wZXJ0eU5hbWVdICE9PSB1bmRlZmluZWQgJiYgZW50aXR5T2JqZWN0W3Byb3BlcnR5TmFtZV0gIT09IHZhbHVlKVxyXG4gICAgICAgICAgICBlbnRpdHlPYmplY3RbcHJvcGVydHlOYW1lXSA9IHZhbHVlO1xyXG4gICAgICAgIGlmIChiYXNlT2JqZWN0W3Byb3BlcnR5TmFtZV0gIT09IHVuZGVmaW5lZCAmJiBiYXNlT2JqZWN0W3Byb3BlcnR5TmFtZV0gIT09IHZhbHVlKVxyXG4gICAgICAgICAgICBiYXNlT2JqZWN0W3Byb3BlcnR5TmFtZV0gPSB2YWx1ZTtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRWYWx1ZShlbnRpdHlPYmplY3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH0sIHByb3BlcnR5SW5mbzogUHJvcGVydHlJbmZvLCBmb3JtQnVpbGRlckNvbmZpZ3VyYXRpb246IEZvcm1CdWlsZGVyQ29uZmlndXJhdGlvbikge1xyXG4gICAgICAgIGxldCBwcm9wVmFsdWUgPSAocHJvcGVydHlJbmZvLmRhdGFQcm9wZXJ0eU5hbWUpID8gZW50aXR5T2JqZWN0W3Byb3BlcnR5SW5mby5kYXRhUHJvcGVydHlOYW1lXSA6IGVudGl0eU9iamVjdFtwcm9wZXJ0eUluZm8ubmFtZV07XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RGVmYXVsdFZhbHVlKHByb3BlcnR5SW5mbyxwcm9wVmFsdWUsZm9ybUJ1aWxkZXJDb25maWd1cmF0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldE9iamVjdFZhbHVlKGVudGl0eU9iamVjdDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSwgY2xhc3NJbnN0YW5jZTogYW55KSB7XHJcbiAgICAgICAgZm9yICh2YXIgY29sdW1uIGluIGVudGl0eU9iamVjdCkge1xyXG4gICAgICAgICAgICBjbGFzc0luc3RhbmNlW2NvbHVtbl0gPSBlbnRpdHlPYmplY3RbY29sdW1uXTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuIl19