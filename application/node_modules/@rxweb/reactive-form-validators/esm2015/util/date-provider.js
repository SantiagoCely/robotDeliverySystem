import { ReactiveFormConfig } from "./reactive-form-config";
import { ApplicationUtil } from './app-util';
const ISO_DATE_REGEX = /^(?:[\+-]?\d{4}(?!\d{2}\b))(?:(-?)(?:(?:0[1-9]|1[0-2])(?:\1(?:[12]\d|0[1-9]|3[01]))?|W(?:[0-4]\d|5[0-2])(?:-?[1-7])?|(?:00[1-9]|0[1-9]\d|[12]\d{2}|3(?:[0-5]\d|6[1-6])))(?:[T\s](?:(?:(?:[01]\d|2[0-3])(?:(:?)[0-5]\d)?|24\:?00)(?:[\.,]\d+(?!:))?)?(?:\2[0-5]\d(?:[\.,]\d+)?)?(?:[zZ]|(?:[\+-])(?:[01]\d|2[0-3]):?(?:[0-5]\d)?)?)?)?$/;
export class DateProvider {
    isDate(value) {
        return value instanceof Date && !isNaN(value.valueOf());
    }
    getRegex(dateFormat) {
        var regExp;
        switch (dateFormat) {
            case 'ymd':
                regExp = "^(?:[0-9]{4})-(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])$";
                break;
            case 'dmy':
                regExp = "^(3[01]|[12][0-9]|0?[1-9])-(1[0-2]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
            case 'mdy':
                regExp = "^(1[0-2]|0?[1-9])-(3[01]|[12][0-9]|0?[1-9])-(?:[0-9]{2})?[0-9]{2}$";
                break;
        }
        return new RegExp(regExp);
    }
    regex() {
        var regExp;
        if (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator)
            regExp = this.getRegex(ReactiveFormConfig.json.internationalization.dateFormat);
        else
            regExp = (ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat) ? this.getRegex(ReactiveFormConfig.json.baseConfig.dateFormat) : this.getRegex("mdy");
        return regExp;
    }
    getDate(value, isBaseFormat = false) {
        let year, month, day;
        if (!this.isDate(value)) {
            let seperator;
            let dateFormat;
            if (ISO_DATE_REGEX.test(value)) {
                return new Date(value);
            }
            else {
                seperator = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.seperator ? ReactiveFormConfig.json.baseConfig.seperator : "/";
                dateFormat = ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.baseConfig && ReactiveFormConfig.json.baseConfig.dateFormat ? ReactiveFormConfig.json.baseConfig.dateFormat : "mdy";
            }
            if (!isBaseFormat && ReactiveFormConfig && ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.dateFormat && ReactiveFormConfig.json.internationalization.seperator) {
                seperator = ReactiveFormConfig.json.internationalization.seperator;
                dateFormat = ReactiveFormConfig.json.internationalization.dateFormat;
            }
            switch (dateFormat) {
                case 'ymd':
                    [year, month, day] = value.split(seperator).map((val) => +val);
                    break;
                case 'dmy':
                    [day, month, year] = value.split(seperator).map((val) => +val);
                    break;
                case 'mdy':
                    [month, day, year] = value.split(seperator).map((val) => +val);
                    break;
            }
            return new Date(year, month - 1, day);
        }
        else
            return value;
    }
    isValid(value, config) {
        if (typeof value == "string") {
            // Fixed issue : https://github.com/rxweb/rxweb/issues/280 & feature request : https://github.com/rxweb/rxweb/issues/295
            if (config && config.allowISODate && ISO_DATE_REGEX.test(value))
                return true;
            let seperator = '/';
            if (ReactiveFormConfig.json && ReactiveFormConfig.json.internationalization && ReactiveFormConfig.json.internationalization.seperator)
                seperator = ReactiveFormConfig.json.internationalization.seperator;
            if (value.split(seperator).length !== 3)
                return false;
            value = value.replace(seperator, '-').replace(seperator, '-');
            return this.regex().test(value);
        }
        else
            return this.isDate(value);
    }
    getConfigDateValue(config) {
        let date = config.value;
        if (config.value && typeof config.value == "string") {
            date = this.getDate(config.value, true);
        }
        return date;
    }
    getCompareDate(config, control) {
        let date = this.getConfigDateValue(config);
        if (config.fieldName) {
            let checkControl = ApplicationUtil.getFormControl(config.fieldName, control);
            if (checkControl && checkControl.value) {
                date = this.getDate(checkControl.value);
            }
        }
        return date;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZS1wcm92aWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3JlYWN0aXZlLWZvcm0tdmFsaWRhdG9ycy91dGlsL2RhdGUtcHJvdmlkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLFlBQVksQ0FBQTtBQUM1QyxNQUFNLGNBQWMsR0FBRyx3VUFBd1UsQ0FBQztBQUNoVyxNQUFNLE9BQU8sWUFBWTtJQUVyQixNQUFNLENBQUMsS0FBVTtRQUNiLE9BQU8sS0FBSyxZQUFZLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUM1RCxDQUFDO0lBRU8sUUFBUSxDQUFDLFVBQWtCO1FBQy9CLElBQUksTUFBYyxDQUFDO1FBQ25CLFFBQVEsVUFBVSxFQUFFO1lBQ2hCLEtBQUssS0FBSztnQkFDTixNQUFNLEdBQUcsMkRBQTJELENBQUM7Z0JBQ3JFLE1BQU07WUFDVixLQUFLLEtBQUs7Z0JBQ04sTUFBTSxHQUFHLG9FQUFvRSxDQUFDO2dCQUM5RSxNQUFNO1lBQ1YsS0FBSyxLQUFLO2dCQUNOLE1BQU0sR0FBRyxvRUFBb0UsQ0FBQztnQkFDOUUsTUFBTTtTQUNiO1FBQ0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRUQsS0FBSztRQUNELElBQUksTUFBYyxDQUFDO1FBQ25CLElBQUksa0JBQWtCLElBQUksa0JBQWtCLENBQUMsSUFBSSxJQUFJLGtCQUFrQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxJQUFJLGtCQUFrQixDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTO1lBQ2xOLE1BQU0sR0FB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QUFDO1FBQ3hCLElBQUksTUFBTSxDQUFDLEtBQUssSUFBSSxPQUFPLE1BQU0sQ0FBQyxLQUFLLElBQUksUUFBUSxFQUFFO1lBQ2pELElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDM0M7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsY0FBYyxDQUFDLE1BQVcsRUFBRSxPQUFZO1FBQ3BDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEVBQUU7WUFDbEIsSUFBSSxZQUFZLEdBQVEsZUFBZSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQ2xGLElBQUksWUFBWSxJQUFJLFlBQVksQ0FBQyxLQUFLLEVBQUU7Z0JBQ3BDLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTthQUMxQztTQUNKO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVhY3RpdmVGb3JtQ29uZmlnIH0gZnJvbSBcIi4vcmVhY3RpdmUtZm9ybS1jb25maWdcIjtcclxuaW1wb3J0IHsgQXBwbGljYXRpb25VdGlsIH0gZnJvbSAnLi9hcHAtdXRpbCdcclxuY29uc3QgSVNPX0RBVEVfUkVHRVggPSAvXig/OltcXCstXT9cXGR7NH0oPyFcXGR7Mn1cXGIpKSg/OigtPykoPzooPzowWzEtOV18MVswLTJdKSg/OlxcMSg/OlsxMl1cXGR8MFsxLTldfDNbMDFdKSk/fFcoPzpbMC00XVxcZHw1WzAtMl0pKD86LT9bMS03XSk/fCg/OjAwWzEtOV18MFsxLTldXFxkfFsxMl1cXGR7Mn18Myg/OlswLTVdXFxkfDZbMS02XSkpKSg/OltUXFxzXSg/Oig/Oig/OlswMV1cXGR8MlswLTNdKSg/Oig6PylbMC01XVxcZCk/fDI0XFw6PzAwKSg/OltcXC4sXVxcZCsoPyE6KSk/KT8oPzpcXDJbMC01XVxcZCg/OltcXC4sXVxcZCspPyk/KD86W3paXXwoPzpbXFwrLV0pKD86WzAxXVxcZHwyWzAtM10pOj8oPzpbMC01XVxcZCk/KT8pPyk/JC87XHJcbmV4cG9ydCBjbGFzcyBEYXRlUHJvdmlkZXIge1xyXG5cclxuICAgIGlzRGF0ZSh2YWx1ZTogYW55KTogQm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4odmFsdWUudmFsdWVPZigpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFJlZ2V4KGRhdGVGb3JtYXQ6IHN0cmluZyk6IFJlZ0V4cCB7XHJcbiAgICAgICAgdmFyIHJlZ0V4cDogc3RyaW5nO1xyXG4gICAgICAgIHN3aXRjaCAoZGF0ZUZvcm1hdCkge1xyXG4gICAgICAgICAgICBjYXNlICd5bWQnOlxyXG4gICAgICAgICAgICAgICAgcmVnRXhwID0gXCJeKD86WzAtOV17NH0pLSgxWzAtMl18MD9bMS05XSktKDNbMDFdfFsxMl1bMC05XXwwP1sxLTldKSRcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdkbXknOlxyXG4gICAgICAgICAgICAgICAgcmVnRXhwID0gXCJeKDNbMDFdfFsxMl1bMC05XXwwP1sxLTldKS0oMVswLTJdfDA/WzEtOV0pLSg/OlswLTldezJ9KT9bMC05XXsyfSRcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICBjYXNlICdtZHknOlxyXG4gICAgICAgICAgICAgICAgcmVnRXhwID0gXCJeKDFbMC0yXXwwP1sxLTldKS0oM1swMV18WzEyXVswLTldfDA/WzEtOV0pLSg/OlswLTldezJ9KT9bMC05XXsyfSRcIjtcclxuICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbmV3IFJlZ0V4cChyZWdFeHApO1xyXG4gICAgfVxyXG5cclxuICAgIHJlZ2V4KCkge1xyXG4gICAgICAgIHZhciByZWdFeHA6IFJlZ0V4cDtcclxuICAgICAgICBpZiAoUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLmRhdGVGb3JtYXQgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uc2VwZXJhdG9yKVxyXG4gICAgICAgICAgICByZWdFeHAgPSB0aGlzLmdldFJlZ2V4KFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLmRhdGVGb3JtYXQpXHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgICAgICByZWdFeHAgPSAoUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5kYXRlRm9ybWF0KSA/IHRoaXMuZ2V0UmVnZXgoUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5kYXRlRm9ybWF0KSA6IHRoaXMuZ2V0UmVnZXgoXCJtZHlcIik7XHJcbiAgICAgICAgcmV0dXJuIHJlZ0V4cDtcclxuICAgIH1cclxuXHJcbiAgICBnZXREYXRlKHZhbHVlOiBzdHJpbmcgfCBEYXRlLCBpc0Jhc2VGb3JtYXQ6IGJvb2xlYW4gPSBmYWxzZSk6IERhdGUge1xyXG4gICAgICAgIGxldCB5ZWFyLCBtb250aCwgZGF5O1xyXG4gICAgICAgIGlmICghdGhpcy5pc0RhdGUodmFsdWUpKSB7XHJcbiAgICAgICAgICAgIGxldCBzZXBlcmF0b3I6IHN0cmluZztcclxuICAgICAgICAgICAgbGV0IGRhdGVGb3JtYXQ6IHN0cmluZztcclxuICAgICAgICAgICAgaWYgKElTT19EQVRFX1JFR0VYLnRlc3QoPHN0cmluZz52YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZSh2YWx1ZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBzZXBlcmF0b3IgPSBSZWFjdGl2ZUZvcm1Db25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24gJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZyAmJiBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5iYXNlQ29uZmlnLnNlcGVyYXRvciA/IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcuc2VwZXJhdG9yIDogXCIvXCI7XHJcbiAgICAgICAgICAgICAgICBkYXRlRm9ybWF0ID0gUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmJhc2VDb25maWcgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5kYXRlRm9ybWF0ID8gUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uYmFzZUNvbmZpZy5kYXRlRm9ybWF0IDogXCJtZHlcIjtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgaWYgKCFpc0Jhc2VGb3JtYXQgJiYgUmVhY3RpdmVGb3JtQ29uZmlnICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLmRhdGVGb3JtYXQgJiYgUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uc2VwZXJhdG9yKSB7XHJcbiAgICAgICAgICAgICAgICBzZXBlcmF0b3IgPSBSZWFjdGl2ZUZvcm1Db25maWcuanNvbi5pbnRlcm5hdGlvbmFsaXphdGlvbi5zZXBlcmF0b3I7XHJcbiAgICAgICAgICAgICAgICBkYXRlRm9ybWF0ID0gUmVhY3RpdmVGb3JtQ29uZmlnLmpzb24uaW50ZXJuYXRpb25hbGl6YXRpb24uZGF0ZUZvcm1hdDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzd2l0Y2ggKGRhdGVGb3JtYXQpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3ltZCc6XHJcbiAgICAgICAgICAgICAgICAgICAgW3llYXIsIG1vbnRoLCBkYXldID0gKDxTdHJpbmc+dmFsdWUpLnNwbGl0KHNlcGVyYXRvcikubWFwKCh2YWw6IHN0cmluZykgPT4gK3ZhbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBjYXNlICdkbXknOlxyXG4gICAgICAgICAgICAgICAgICAgIFtkYXksIG1vbnRoLCB5ZWFyXSA9ICg8U3RyaW5nPnZhbHVlKS5zcGxpdChzZXBlcmF0b3IpLm1hcCgodmFsOiBzdHJpbmcpID0+ICt2YWwpO1xyXG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgICAgICAgICAgY2FzZSAnbWR5JzpcclxuICAgICAgICAgICAgICAgICAgICBbbW9udGgsIGRheSwgeWVhcl0gPSAoPFN0cmluZz52YWx1ZSkuc3BsaXQoc2VwZXJhdG9yKS5tYXAoKHZhbDogc3RyaW5nKSA9PiArdmFsKTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gbmV3IERhdGUoeWVhciwgbW9udGggLSAxLCBkYXkpO1xyXG4gICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gPERhdGU+dmFsdWU7XHJcbiAgICB9XHJcblxyXG4gICAgaXNWYWxpZCh2YWx1ZTogc3RyaW5nIHwgRGF0ZSwgY29uZmlnOiBhbnkpOiBCb29sZWFuIHtcclxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09IFwic3RyaW5nXCIpIHtcclxuICAgICAgICAgICAgLy8gRml4ZWQgaXNzdWUgOiBodHRwczovL2dpdGh1Yi5jb20vcnh3ZWIvcnh3ZWIvaXNzdWVzLzI4MCAmIGZlYXR1cmUgcmVxdWVzdCA6IGh0dHBzOi8vZ2l0aHViLmNvbS9yeHdlYi9yeHdlYi9pc3N1ZXMvMjk1XHJcbiAgICAgICAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLmFsbG93SVNPRGF0ZSAmJiBJU09fREFURV9SRUdFWC50ZXN0KDxzdHJpbmc+dmFsdWUpKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgICAgIGxldCBzZXBlcmF0b3IgPSAnLydcclxuICAgICAgICAgICAgaWYgKFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uICYmIFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcilcclxuICAgICAgICAgICAgICAgIHNlcGVyYXRvciA9IFJlYWN0aXZlRm9ybUNvbmZpZy5qc29uLmludGVybmF0aW9uYWxpemF0aW9uLnNlcGVyYXRvcjtcclxuICAgICAgICAgICAgaWYgKHZhbHVlLnNwbGl0KHNlcGVyYXRvcikubGVuZ3RoICE9PSAzKVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2Uoc2VwZXJhdG9yLCAnLScpLnJlcGxhY2Uoc2VwZXJhdG9yLCAnLScpO1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZWdleCgpLnRlc3QodmFsdWUpO1xyXG4gICAgICAgIH0gZWxzZVxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pc0RhdGUodmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldENvbmZpZ0RhdGVWYWx1ZShjb25maWcpIHtcclxuICAgICAgICBsZXQgZGF0ZSA9IGNvbmZpZy52YWx1ZTtcclxuICAgICAgICBpZiAoY29uZmlnLnZhbHVlICYmIHR5cGVvZiBjb25maWcudmFsdWUgPT0gXCJzdHJpbmdcIikge1xyXG4gICAgICAgICAgICBkYXRlID0gdGhpcy5nZXREYXRlKGNvbmZpZy52YWx1ZSwgdHJ1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBkYXRlO1xyXG4gICAgfVxyXG5cclxuICAgIGdldENvbXBhcmVEYXRlKGNvbmZpZzogYW55LCBjb250cm9sOiBhbnkpIHtcclxuICAgICAgICBsZXQgZGF0ZSA9IHRoaXMuZ2V0Q29uZmlnRGF0ZVZhbHVlKGNvbmZpZyk7XHJcbiAgICAgICAgaWYgKGNvbmZpZy5maWVsZE5hbWUpIHtcclxuICAgICAgICAgICAgbGV0IGNoZWNrQ29udHJvbDogYW55ID0gQXBwbGljYXRpb25VdGlsLmdldEZvcm1Db250cm9sKGNvbmZpZy5maWVsZE5hbWUsIGNvbnRyb2wpO1xyXG4gICAgICAgICAgICBpZiAoY2hlY2tDb250cm9sICYmIGNoZWNrQ29udHJvbC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgZGF0ZSA9IHRoaXMuZ2V0RGF0ZShjaGVja0NvbnRyb2wudmFsdWUpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGRhdGU7XHJcbiAgICB9XHJcbn1cclxuIl19